# Manga Tracker

Автоматичний трекер нових глав манги з сповіщеннями в Telegram.

## Що робить

- Щодня перевіряє нові глави для списку манг
- Відправляє звіт в Telegram з результатами і посиланнями
- Підтримує сайти: **com-x.life**, **mangabuff.ru**, **mangalib.me** та інші через fallback
- Керування списком манг через Telegram бота без редагування файлів

## Структура проекту

```
manga/
├── core/
│   ├── checker.py           # Логіка перевірки з файловим локом
│   ├── logger.py            # Централізоване логування
│   ├── parser_playwright.py # Парсери сайтів (async + Playwright)
│   ├── storage.py           # Робота з data.json
│   └── telegram_sender.py   # Відправка повідомлень
├── config/
│   └── config.py            # Читає налаштування з .env
├── data/
│   ├── data.json            # Список манг і останні глави
│   ├── data.json.bak        # Автоматичний бекап (створюється програмою)
│   └── manga.log            # Лог всіх запусків
├── .env                     # Токени і налаштування
├── .env.example             # Шаблон .env для нових користувачів
├── paths.py                 # Налаштування шляхів імпорту
├── Main.py                  # Щоденна автоматична перевірка
├── bot.py                   # Telegram бот для ручного керування
├── run_silent.vbs           # Тихий запуск без вікна CMD
├── requirements.txt         # Список залежностей
```

### 1. Встанови залежності

```bash
pip install -r requirements.txt
```

### 2. Встанови браузер для Playwright

```bash
playwright install chromium
```

### 3. Створи `.env` файл

Скопіюй шаблон і заповни своїми даними:

```bash
cp .env.example .env
```

Відкрий `.env` і встав свої значення:

```env
TELEGRAM_TOKEN=твій_токен_від_BotFather
TELEGRAM_CHAT_ID=твій_chat_id

# Режим браузера: true = фоновий, false = видно вікно (для дебагу)
HEADLESS=true

# Максимум одночасних вкладок браузера
MAX_CONCURRENT_PAGES=10

# Скидати контекст браузера кожні N манг (очищає кеш і пам'ять)
CONTEXT_RESET_EVERY=20

# Максимальний час очікування на одну мангу в секундах
PAGE_TIMEOUT=120
```
### 4. Створи `data/data.json`

```json
{
    "last_check_date": "",
    "manga": {
        "Назва манги": {
            "url": "https://com-x.life/...",
            "last_chapter": "невідомо"
        }
    }
}
```

Або просто запусти `Main.py` — файл створюється автоматично з порожнім списком.

---

## Запуск

### Ручна перевірка

```bash
python Main.py
```

Перевіряє всі манги і відправляє звіт в Telegram.  
Якщо перевірка вже була сьогодні — пропускає.

### Telegram бот

```bash
python bot.py
```

#### Команди бота

| Команда | Опис |
|---------|------|
| `/start` | Привітання і список команд |
| `/status` | Список всіх манг з останніми главами і посиланнями |
| `/add Назва \| URL` | Додати мангу |
| `/remove Назва` | Видалити мангу |
| `/check` | Перевірити всі манги прямо зараз |

#### Приклади

```
/add Моя манга | https://mangabuff.ru/manga/test
/remove Моя манга
```

### Автозапуск на Windows (без вікна CMD)

1. Відкрий `run_silent.vbs` і перевір шлях:
   ```vbs
   objShell.Run "python C:\шлях\до\manga\Main.py", 0, False
   ```

2. Відкрий **Планувальник завдань** → "Створити просте завдання"
   - Тригер: при вході в систему або щодня о потрібній годині
   - Програма: `wscript.exe`
   - Аргументи: `C:\шлях\до\manga\run_silent.vbs`
   - Початкова папка: `C:\шлях\до\manga`

---

## Підтримувані сайти

| Сайт | Метод парсингу | Примітка |
|------|---------------|---------|
| com-x.life | `window.__DATA__` через JS | З regex fallback |
| mangabuff.ru | Посилання `/chapter/N` | З текстовим fallback |
| mangalib.me | Прямий API запит | Без браузера, найшвидший |
| Інші сайти | Fallback — пошук "Глава/Розділ/Chapter N" | Може не працювати на всіх |

### Додати новий сайт

Відкрий `core/parser_playwright.py` і додай новий парсер:

```python
#@register_parser("новий-сайт.com")
#@retry(times=3, delay=2.0)
async def _parse_новий(page, url: str) -> str:
    await page.goto(url, timeout=40000, wait_until="domcontentloaded")
    # твоя логіка парсингу
    ...
```

Більше нічого міняти не треба — `_check_one` підхопить його автоматично.

---

## Логування

Всі події записуються в `data/manga.log`:

```
[2026-02-19 10:00:01] [manga.main] Починаємо перевірку 5 манг паралельно
[2026-02-19 10:00:03] [manga.parser]  Перевіряємо: Три геніальні сестри 
[2026-02-19 10:00:04] [manga.parser]   com-x.life: 199
[2026-02-19 10:00:05] [manga.checker] Збережено результати
```

При запуску з PyCharm або терміналу — виводиться також в консоль.  
При фоновому запуску (планувальник) — тільки у файл.

---

## Захист даних

- Токени зберігати тільки в `.env`
- Перед кожним збереженням автоматично створюється `data.json.bak`
- Якщо `data.json` пошкоджений - програма автоматично відновлює з бекапу
- Бот відповідає тільки на команди від власника (перевірка по `CHAT_ID`)

---

## Залежності

```
python-telegram-bot  — Telegram бот
playwright           — парсинг JS сайтів через браузер
aiohttp              — асинхронні HTTP запити (mangalib API)
python-dotenv        — читання .env файлу
filelock             — захист від одночасного запису
```

Встановити всі одразу:
```bash
pip install -r requirements.txt
playwright install chromium
```